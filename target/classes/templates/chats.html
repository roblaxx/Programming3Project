<!DOCTYPE html>
<html lang="en" xmlns:th="https://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chats list</title>
    <link rel="stylesheet" href="/css/style.css?version=6">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
</head>
<body>
<header class="links">
    <a href="/homepage">
        <span class="material-icons" style="font-size: 22px">home</span>
    </a>
    <form action="/logout" method="post">
        <button type="submit">Sign out</button>
    </form>
</header>
<main>
    <h1>Chats list</h1>
    <div class="search-container">
        <input type="text" id="searchInput" onkeyup="searchChats()" placeholder="Looking for a chat ..." class="search-bar">
        <button type="button" id="disabledFilterBtn" onclick="toggleDisabledFilter()" style="margin-left: 10px;">Only show disabled chats</button>
    </div>
    <table id="chatTable" class="customTable">
        <tr>
            <th onclick="sortTable(0)">Creator</th>
            <th onclick="sortTable(1)">Title</th>
            <th onclick="sortTable(2)">Description</th>
            <th onclick="sortTable(3)">Starting date</th>
            <th onclick="sortTable(4)">Ending date</th>
            <th onclick="sortTable(5)">Invited Users</th>
            <th onclick="sortTable(6)">Active</th>
            <th></th>
            <th></th>
        </tr>
        <tr th:each="chatInfo : ${chatsInfo}" class="item" th:attr="data-disabled=${chatInfo.get('isDisabled')}">
            <td th:text="${chatInfo.get('owner')}"></td>
            <td th:text="${chatInfo.get('title')}"></td>
            <td th:text="${chatInfo.get('description')}"></td>
            <td th:text="${chatInfo.get('date')}"></td>
            <td th:text="${chatInfo.get('validityDate')}"></td>
            <td>
                <span th:each="mappedItem : ${chatInfo.get('invitedUsers')}">
                    <span th:each="item : ${mappedItem.entrySet()}">
                        <span th:text="${item.key}"></span>
                        <br/>
                        <span>
                            <span th:if="${item.value}" class="material-icons" style="color: green; font-size: 22px">check_circle</span>
                            <span th:unless="${item.value}" class="material-icons" style="color: red; font-size: 22px">cancel</span>
                        </span>
                    <br/><br/>
                    </span>
                </span>
            </td>
            <td>
                <span th:if="${!chatInfo.get('isDisabled')}" class="material-icons" style="color: green; font-size: 22px">check_circle</span>
                <span th:if="${chatInfo.get('isDisabled')}" class="material-icons" style="color: red; font-size: 22px">cancel</span>
            </td>
            <td>
                <form th:action="@{/chats/{id}(id=${chatInfo.get('chatId')})}" method="post">
                    <button type="submit">
                        <span class="material-icons" style="font-size: 22px">edit</span>
                    </button>
                </form>
            </td>
            <td>
                <a th:href="@{/chats/delete/{id}(id=${chatInfo.get('chatId')})}" class="buttonStyle">
                    <button type="submit">
                        <span class="material-icons" style="font-size: 22px">delete</span>
                    </button>
                </a>
            </td>
        </tr>
    </table>
    <div class="pagination">
        <button id="prevPage" onclick="previousPage()">Previous</button>
        <span id="pageInfo">Page 1</span>
        <button id="nextPage" onclick="nextPage()">Next</button>
    </div>
    <div class="links">
        <a href="/addChat">Create a chat</a>
    </div>
    <div th:if="${message}" class="popup-overlay" id="popupMessage">
        <div class="popup-message">
            <span th:text="${message}"></span>
            <button onclick="document.getElementById('popupMessage').style.display='none'" class="close-popup">
                <span class="material-icons" style="font-size: 22px">close</span>
            </button>
        </div>
    </div>
</main>
<script>
    let currentPage = 1;
    const itemsPerPage = 4;
    function updatePagination() {
        const allRows = Array.from(document.querySelectorAll('#chatTable .item'));
        // Finding the lines that get into the filters
        const visibleRows = allRows.filter(row => !row.classList.contains('filtered-out'));
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;

        // Step 1 : Hide all lines
        allRows.forEach(row => row.style.display = 'none');

        // Step 2 : Show the adequates lines
        visibleRows.slice(startIndex, endIndex).forEach(row => row.style.display = '');

        // Refresh the elements of the page
        document.getElementById('pageInfo').textContent = `Page ${currentPage}`;
        document.getElementById('prevPage').disabled = currentPage === 1;
        document.getElementById('nextPage').disabled = endIndex >= visibleRows.length;
    }
    function previousPage() {
        if (currentPage > 1) {
            currentPage--;
            updatePagination();
        }
    }

    function nextPage() {
        currentPage++;
        updatePagination();
    }
    function sortTable(n) {
        let table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        table = document.getElementById("chatTable");
        switching = true;
        // Ascending sorting:
        dir = "asc";
        /* Loop until an exchange is done */
        while (switching) {
            switching = false;
            rows = table.rows;
            /* Loop on all lines except headers */
            for (i = 1; i < (rows.length - 1); i++) {
                // Start by saying there should be no switching:
                shouldSwitch = false;
                /* Comparaison between the current element and the following one: */
                x = rows[i].getElementsByTagName("TD")[n];
                y = rows[i + 1].getElementsByTagName("TD")[n];
                /* Compare via the direction */
                if (dir == "asc") {
                    if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                        shouldSwitch = true;
                        break;
                    }
                } else if (dir == "desc") {
                    if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                        shouldSwitch = true;
                        break;
                    }
                }
            }
            if (shouldSwitch) {
                /* If a switch has te done */
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                // Switch counter
                switchcount ++;
            } else {
                /* If no switch AND ascending direction,
                put the direction at "desc" et re-loop. */
                if (switchcount == 0 && dir == "asc") {
                    dir = "desc";
                    switching = true;
                }
            }
        }
        currentPage = 1;  // // Refresh the page
        updatePagination();
    }

    let showDisabledOnly = false;

    function toggleDisabledFilter() {
        showDisabledOnly = !showDisabledOnly;
        const btn = document.getElementById("disabledFilterBtn");
        btn.textContent = showDisabledOnly ? "Afficher tous les chats" : "Afficher uniquement les chats désactivés";
        searchChats(); // Do the search again
        currentPage = 1;  // Refresh the page
        updatePagination();
    }

    function searchChats() {
        const input = document.getElementById("searchInput");
        const filter = input.value.trim().toLowerCase();
        const table = document.getElementById("chatTable");
        const rows = table.getElementsByClassName("item");
        for (let row of rows) {
            const title = row.getElementsByTagName("td")[1].textContent.toLowerCase();
            const description = row.getElementsByTagName("td")[2].textContent.toLowerCase();
            const isDisabled = row.getAttribute("data-disabled") === "true";
            const matchesDisabled = !showDisabledOnly || isDisabled;
            const matchesSearch = (title.includes(filter) || description.includes(filter));
            if (matchesSearch && matchesDisabled) {
                row.classList.remove('filtered-out');
            } else {
                row.classList.add('filtered-out');
            }
        }
        currentPage = 1;  // // Refresh the page
        updatePagination();
    }
    document.addEventListener('DOMContentLoaded', updatePagination);
</script>
</body>
</html>